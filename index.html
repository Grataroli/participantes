<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Sorteio de Números</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 550px;
      margin: auto;
      padding: 1rem;
      overflow-x: hidden;
    }

    form {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }

    input {
      flex: 1 1 10%;
      padding: 0.5rem;
    }

    button {
      padding: 0.5rem 1rem;
      cursor: pointer;
    }

    .info-box {
      font-weight: bold;
      margin-bottom: 1rem;
      font-size: 1rem;
    }

    .tabela-wrapper {
      max-height: 300px;
      overflow: auto;
      border: 1px solid #ccc;
      margin-top: 1rem;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 600px;
    }

    th, td {
      padding: 0.5rem;
      border: 1px solid #ccc;
      text-align: left;
      white-space: nowrap;
    }

    #resultado {
      margin-top: 1rem;
      font-weight: bold;
      font-size: 1.2rem;
    }

    .grid-container {
      margin-top: 2rem;
    }

    .grade {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(40px, 1fr));
      gap: 4px;
      max-width: 100%;
    }

    .numero {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: center;
      font-size: 14px;
      position: relative;
    }

    .riscado::after {
      content: '';
      position: absolute;
      width: 100%;
      height: 2px;
      background: red;
      transform: rotate(-45deg);
      top: 50%;
      left: 0;
    }

    @media (max-width: 600px) {
      .grade {
        grid-template-columns: repeat(auto-fill, minmax(30px, 1fr));
      }

      .tabela-wrapper {
        max-width: 100%;
        overflow-x: auto;
      }
    }
  </style>
</head>
<body>
  <h1>Sorteio de Números</h1>

  <div class="info-box" id="info"></div>

  <h2>Adicionar Número</h2>
  <form id="formulario-adicionar">
    <input type="text" id="nome-adicionar" placeholder="Nome" required />
    <input type="text" id="numero-adicionar" placeholder="Número(s) (1-500, separados por vírgula ou espaço)" required />
    <button type="submit">Adicionar</button>
  </form>

  ---

  <h2>Excluir Número</h2>
  <form id="formulario-excluir">
    <input type="text" id="nome-excluir" placeholder="Nome (opcional)" />
    <input type="text" id="numero-excluir" placeholder="Número(s) a excluir (separados por vírgula ou espaço)" required />
    <button type="submit">Excluir</button>
  </form>

  ---

  <div style="display: flex; gap: 1rem; margin-top: 1rem;">
    <button onclick="sortear()">Sortear Número</button>
  </div>

  <div id="resultado"></div>

  <div class="tabela-wrapper">
    <table>
      <thead>
        <tr>
          <th>Nome</th>
          <th>Números Comprados</th>
        </tr>
      </thead>
      <tbody id="tabela"></tbody>
    </table>
  </div>

  <div class="grid-container">
    <h3>Números Comprados</h3>
    <div class="grade" id="grade-numeros"></div>
  </div>

  <script>
    // **Atenção:** Substitua estes valores pelas suas chaves do Supabase!
    // Você pode encontrá-las no painel do seu projeto Supabase, em "Settings" -> "API".
    const supabaseUrl = "https://pzbzolxtvyxvkaobfvfy.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB6YnpvbHh0dnl4dmthb2JmdmZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg5NjUxOTEsImV4cCI6MjA2NDU0MTE5MX0.2d3N8a5mdOwYXiO_QkG27PD9WehU8Kg4KG6u6AIFTiY";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const formAdicionar = document.getElementById("formulario-adicionar");
    const formExcluir = document.getElementById("formulario-excluir");
    const tabela = document.getElementById("tabela");
    const resultado = document.getElementById("resultado");
    const info = document.getElementById("info");

    // Event Listener para ADICIONAR números
    formAdicionar.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nome = document.getElementById("nome-adicionar").value.trim();
      const numeroInput = document.getElementById("numero-adicionar").value.trim();

      if (!nome) {
        alert("Por favor, preencha um nome válido.");
        return;
      }

      const numerosParaAdicionar = numeroInput
        .split(/[, ]+/) // Divide por uma ou mais vírgulas ou espaços
        .filter(s => s !== '') // Remove strings vazias
        .map(s => parseInt(s)); // Converte para inteiros

      if (numerosParaAdicionar.length === 0) {
        alert("Por favor, insira pelo menos um número válido entre 1 e 500.");
        return;
      }

      const numerosInvalidos = numerosParaAdicionar.filter(n => isNaN(n) || n < 1 || n > 500);
      if (numerosInvalidos.length > 0) {
        alert(`Os seguintes números são inválidos (devem ser entre 1 e 500): ${numerosInvalidos.join(', ')}`);
        return;
      }

      const numerosJaExistentes = [];
      const numerosParaInserir = [];

      for (const numero of numerosParaAdicionar) {
        const { data: existentes, error: erroBusca } = await supabase
          .from("participantes")
          .select("*")
          .eq("numero", numero);

        if (erroBusca) {
          alert("Erro ao verificar número: " + erroBusca.message);
          return;
        }

        if (existentes.length > 0) {
          numerosJaExistentes.push(numero);
        } else {
          numerosParaInserir.push({ nome, numero });
        }
      }

      if (numerosJaExistentes.length > 0) {
        alert(`Os seguintes números já foram escolhidos: ${numerosJaExistentes.join(', ')}`);
        return;
      }

      if (numerosParaInserir.length > 0) {
        const { error } = await supabase
          .from("participantes")
          .insert(numerosParaInserir);

        if (error) {
          alert("Erro ao salvar: " + error.message);
          return;
        }
      }

      formAdicionar.reset();
      await atualizarTabela();
    });


    // Event Listener para EXCLUIR números
    formExcluir.addEventListener("submit", async (e) => {
      e.preventDefault();

      const nomeExcluir = document.getElementById("nome-excluir").value.trim(); // Opcional
      const numeroInputExcluir = document.getElementById("numero-excluir").value.trim();

      const numerosParaExcluir = numeroInputExcluir
        .split(/[, ]+/)
        .filter(s => s !== '')
        .map(s => parseInt(s));

      if (numerosParaExcluir.length === 0) {
        alert("Por favor, insira pelo menos um número para excluir.");
        return;
      }

      const numerosInvalidos = numerosParaExcluir.filter(n => isNaN(n) || n < 1 || n > 500);
      if (numerosInvalidos.length > 0) {
        alert(`Os seguintes números não são válidos para exclusão (devem ser entre 1 e 500): ${numerosInvalidos.join(', ')}`);
        return;
      }

      let numerosExcluidosComSucesso = [];
      let numerosNaoEncontrados = [];

      for (const numero of numerosParaExcluir) {
        // Busca o número para confirmar que ele existe e, opcionalmente, se o nome corresponde
        let query = supabase.from("participantes").select("*").eq("numero", numero);
        if (nomeExcluir) {
          query = query.eq("nome", nomeExcluir);
        }

        const { data: existente, error: erroBusca } = await query;

        if (erroBusca) {
          alert("Erro ao buscar número para exclusão: " + erroBusca.message);
          return;
        }

        if (existente.length > 0) {
          const { error: erroExclusao } = await supabase
            .from("participantes")
            .delete()
            .eq("numero", numero); // Exclui pelo número

          if (erroExclusao) {
            alert("Erro ao excluir o número " + numero + ": " + erroExclusao.message);
            return;
          }
          numerosExcluidosComSucesso.push(numero);
        } else {
          numerosNaoEncontrados.push(numero);
        }
      }

      let mensagem = [];
      if (numerosExcluidosComSucesso.length > 0) {
        mensagem.push(`Números excluídos com sucesso: ${numerosExcluidosComSucesso.join(', ')}.`);
      }
      if (numerosNaoEncontrados.length > 0) {
        mensagem.push(`Números não encontrados ou não associados ao nome informado: ${numerosNaoEncontrados.join(', ')}.`);
      }

      alert(mensagem.join('\n')); // Exibe uma mensagem consolidada

      formExcluir.reset();
      await atualizarTabela();
    });


    async function atualizarTabela() {
      const { data, error } = await supabase.from("participantes").select("*");

      if (error) {
        alert("Erro ao carregar participantes: " + error.message);
        return;
      }

      const totalNumeros = data.length;
      const valorRifa = 5.00;
      const valorUnitario = 5.00;
      const totalArrecadado = totalNumeros * valorUnitario;

      info.textContent = `Valor da rifa: R$ ${valorRifa.toFixed(2).replace('.', ',')} | Total arrecadado: R$ ${totalArrecadado.toFixed(2).replace('.', ',')} (${totalNumeros} números vendidos)`;

      const participantesMap = new Map();
      data.forEach(p => {
        if (!participantesMap.has(p.nome)) {
          participantesMap.set(p.nome, []);
        }
        participantesMap.get(p.nome).push(p.numero);
      });

      const participantesOrdenados = Array.from(participantesMap.entries())
        .sort((a, b) => a[0].localeCompare(b[0]));
      participantesOrdenados.forEach(([nome, numeros]) => numeros.sort((a, b) => a - b));

      tabela.innerHTML = "";
      participantesOrdenados.forEach(([nome, numeros]) => {
        const row = document.createElement("tr");
        row.innerHTML = `<td>${nome}</td><td>${numeros.join(', ')}</td>`;
        tabela.appendChild(row);
      });

      const numerosComprados = new Set(data.map(p => p.numero));
      const grade = document.getElementById("grade-numeros");
      grade.innerHTML = "";

      for (let i = 1; i <= 500; i++) {
        const div = document.createElement("div");
        div.classList.add("numero");
        div.textContent = i;
        if (numerosComprados.has(i)) div.classList.add("riscado");
        grade.appendChild(div);
      }
    }

    async function sortear() {
      const { data, error } = await supabase.from("participantes").select("*");

      if (error) {
        alert("Erro ao buscar dados: " + error.message);
        return;
      }

      if (!data || data.length === 0) {
        resultado.textContent = "Nenhum participante encontrado para sortear.";
        return;
      }

      const sorteado = data[Math.floor(Math.random() * data.length)];
      resultado.textContent = `Número sorteado: ${sorteado.numero} - ${sorteado.nome}`;
    }

    document.addEventListener("DOMContentLoaded", atualizarTabela);
  </script>
</body>
</html>